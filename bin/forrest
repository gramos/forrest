#!/usr/bin/env ruby

require 'ftools'
require 'rubygems'
# require 'active_support/core_ext/array'
# require 'active_support/core_ext/date'
require 'test/unit/ui/console/testrunner'

require File.join(File.dirname(__FILE__), '../lib/object')
require File.join(File.dirname(__FILE__), '../lib/forrest/unix_console_styler')

module Stories

  class ForrestRunner < Test::Unit::UI::Console::TestRunner
    def test_finished(name)
      set_story
    end

    def add_fault(fault)
      @faults << fault
    end

    def set_story
      s      ||= Story.new @suite.name
      @story ||= Stories.all[s.name.constantize]
    end

    def print_scenario(scenario)
      scenario.steps.each do |step|
        puts "      #{step}"
      end

      scenario.assertions.each do |assertion|
        puts "      #{assertion}"
      end

      puts
    end

    def print_story
      puts "- #{colorize(@story.name, :bold)} \n\n"

      @story.scenarios.each do |scenario|
        puts "    #{scenario.name}"

        unless scenario.steps.empty? && scenario.assertions.empty?
          print_scenario scenario
        end
      end
    end

    def finished(elapsed_time)
      puts
      print_story
      super
      stories_count   = 1
      scenarios_count = @story.scenarios.size

      puts colorize("#{stories_count} story, ", :bold) +
           colorize(" #{scenarios_count} scenarios", :bold)

    end
  end

end

def print_test_cases(test_cases)
  test_cases.each{|tc|
    tests = tc.suite.tests
    puts "\n+ #{colorize(tc, :bold)}"
    tests.each{|t|
      puts "|__ #{colorize(tc, :cyan)}##{colorize(t.method_name, :yellow)}"
    }
  }
end

def can_load_rails_env?
  File.file? rails_env_path
end

def rails_env_path
  File.expand_path(File.dirname(@test_file.to_s) + "/../../config/environment")
end

def require_active_support_or_rails_env
  if can_load_rails_env?
    require rails_env_path
  else
    require 'active_support/core_ext/string/inflections'
    require 'active_support/core_ext/string'
  end
end


def show
  @test_file  = ARGV[0]
  require @test_file
  require_active_support_or_rails_env
  @test_cases = test_class.subclasses
  print_test_cases(@test_cases)
  begin
    Test::Unit::UI::Console::TestRunner.run(nil)
  rescue NoMethodError
  end
end

def run_story
  @test_class = ARGV[0]
  require test_file
  Stories::ForrestRunner.run(@test_class.constantize)
end

def run_scenario
  @test_class = ARGV[0].split("#")[0]
  @test_name  = ARGV[0].split("#")[1]
  puts test_file
  require test_file
  test = @test_class.constantize.suite.tests.find{|t|
    t.method_name == @test_name
  }

  Test::Unit::UI::Console::TestRunner.run(test)
end

def test_class
  @test_class = File.basename(@test_file, ".rb").camelize.constantize
end

def test_file
  @test_file  = "test/#{@test_class.split("::")[0].underscore}"
end

def colorize(text, color)
  "#{UnixConsoleStyler::STYLE[color]}#{text}\e[0m"
end

if File.file? ARGV[0]
  show
else
  require_active_support_or_rails_env
  if ARGV[0].include? "#"
    puts "==> Runing scenario...\n\n"
    run_scenario
  else
    puts "==> Runing story...\n\n"
    run_story
  end
end


